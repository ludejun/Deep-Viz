"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes);require("./amp.css");var AMapDistrictCluster=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return _inherits(t,_react2.default.Component),_createClass(t,[{key:"componentDidMount",value:function(){var e=this;if(window.mapRender=this.mapRender.bind(this),window.AMap)this.mapRender();else{var t=document.createElement("script");t.src="https://webapi.amap.com/maps?v=1.3&key=5f47a71f72692f5e7160f7b577d72a82&callback=mapRender&plugin=AMap.ToolBar",document.head.appendChild(t)}var r=document.createElement("script");r.async=!1,r.type="text/javascript",r.src="https://webapi.amap.com/ui/1.0/main.js?v=1.0.11",document.head.appendChild(r),r.onload=function(){window.AMapUI.load(["ui/geo/DistrictCluster","lib/$","lib/utils"],function(t,r,i){window.DistrictCluster=t,e.props.labelConfig?e.initPage(t,r,i):e.props.labelConfig||e.initPage1(t,r,i)})}}},{key:"mapRender",value:function(){this.amap=new window.AMap.Map("ampClusterContainer",{zoom:1}),this.amap.addControl(new window.AMap.ToolBar)}},{key:"initPage1",value:function(e,t){var r=new e({zIndex:0,map:this.amap,autoSetFitView:!1,getPosition:function(e){if(!e)return null;var t=e.split(",");return[parseFloat(t[0]),parseFloat(t[1])]}});window.distCluster=r,t('<div id="loadingTip">加载数据，请稍候...</div>').appendTo(document.body),t("#loadingTip").remove(),r.setData(this.props.point)}},{key:"initPage",value:function(e,t,r){function i(e,t,r,n,o){i.__super__.constructor.call(this,e,t,r,n,o)}var n=this.amap,o=this,a=this.props.renderOptions;r.inherit(i,e.Render.Default),r.extend(i.prototype,{drawFeaturePolygons:function(e,t,r,n,o){i.__super__.drawFeaturePolygons.call(this,e,t,r,n,o),this.drawMyLabel(n,o)},_initContainter:function(e,t,r,n,o){i.__super__._initContainter.call(this,e,t,r,n,o),this._createCanvas("mylabel",this._container)},drawMyLabel:function(e,t){var r=this.getPixelRatio(),i=n.lngLatToContainer(e.properties.centroid||e.properties.center),a=this._getCanvasCxt("mylabel"),l=i.getX()*r,s=i.getY()*r;a.save(),a.font=14*r+"px 微软雅黑";var p=e.properties.name+"("+t.length+")",u=a.measureText(p),c=u.width/2;a.fillStyle=o.props.labelConfig.fillStyle||"#108EE9","rect"===o.props.labelConfig.type?a.fillRect(l-c-3*r,s-11*r,u.width+6*r,22*r):"circle"===o.props.labelConfig.type&&(a.beginPath(),a.arc(l,s,c*r/2/2,0,2*Math.PI),a.fill(),a.closePath()),a.fillStyle=o.props.labelConfig.color||"#fff",a.textBaseline="middle",a.fillText(p,l-c,s),a.restore()}});var l=new e({zIndex:200,map:this.amap,autoSetFitView:!1,getPosition:function(e){if(!e)return null;var t=e.split(",");return[parseFloat(t[0]),parseFloat(t[1])]},renderConstructor:i,renderOptions:{getClusterMarker:null,featureClickToShowSub:!0,featureStyle:{fillStyle:"#9cd49b",lineWidth:a?a.lineWidth:1,strokeStyle:a?a.strokeStyle:"#1f77b4",hoverOptions:{fillStyle:a?a.hoverColor:"#b0ddaf",lineWidth:a?a.hoverLineWidth:1,strokeStyle:a?a.hoverStrokeStyle:"#1f77b4"}}}});window.distCluster=l,t('<div id="loadingTip">加载数据，请稍候...</div>').appendTo(document.body),t("#loadingTip").remove(),l.setData(this.props.point)}},{key:"render",value:function(){var e=this.props.style,t=void 0===e?{}:e;return _react2.default.createElement("div",{style:{position:"relative"}},_react2.default.createElement("div",{id:"ampClusterContainer",style:_extends({width:"100%",height:630},t)}))}}]),t}();exports.default=AMapDistrictCluster,AMapDistrictCluster.propTypes={style:_propTypes2.default.object,labelConfig:_propTypes2.default.shape({type:_propTypes2.default.string.isRequired,fillStyle:_propTypes2.default.string.isRequired,color:_propTypes2.default.string.isRequired})};