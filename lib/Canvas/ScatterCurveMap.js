"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_propTypes=require("prop-types"),_propTypes2=_interopRequireDefault(_propTypes),ScatterCurveMap=function(t){function e(t){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.mapLoad=function(){(new BMap.Boundary).get(i.props.mapConfig.map.name||"徐汇区",function(t){var e=[];t.boundaries.length>0&&(e=t.boundaries[0].split(";"));var a=e.map(function(t){var e=t.split(",");return i.lonlatTomercator([Number(e[0]),Number(e[1])])});i.chinaPoints=a,i.renderMap(),i.renderCircle(),i.offContext.drawImage(i.canvas,0,0)})},i.loadScript=function(){var t=document.createElement("script");t.src="https://api.map.baidu.com/api?v=2.0&ak=C4f54f1b740bc62107184968edbb64fb&callback=mapLoad",document.body.appendChild(t)},i.renderMap=function(){if(Array.isArray(i.chinaPoints)&&i.chinaPoints.length>0){i.maxScreenDis=Math.min(i.canvas.width,i.canvas.height),i.minLng=i.chinaPoints[0][0],i.maxLat=i.chinaPoints[0][1],i.maxLng=i.chinaPoints[0][0],i.minLat=i.chinaPoints[0][1],i.chinaPoints.forEach(function(t){i.minLng=Math.min(i.minLng,t[0]),i.maxLat=Math.max(i.maxLat,t[1]),i.maxLng=Math.max(i.maxLng,t[0]),i.minLat=Math.min(i.maxLat,t[1])}),i.centerPoint=[(i.minLng+i.maxLng)/2,(i.maxLat+i.minLat)/2],i.currentSource=i.centerPoint,i.ratio=1.3*Math.min(i.canvas.width,i.canvas.height)/i.distancePoint([i.minLng,i.maxLat],[i.maxLng,i.minLat]),i.chinaPoints.forEach(function(t){i.maxLength=Math.max(i.maxLength,i.distancePoint([i.minLng,i.maxLat],t))}),i.ratio=i.maxScreenDis/i.maxLength;var t=[];i.chinaPoints.forEach(function(e){var a=-(e[1]-i.centerPoint[1])*i.ratio,n=(e[0]-i.centerPoint[0])*i.ratio;t.push([n,a])}),i.context=i.canvas.getContext("2d"),i.context.fillStyle=i.props.mapConfig.map.mapBackgroundColor||"#020B22",i.context.fillRect(0,0,i.canvas.width,i.canvas.height),i.context.translate(i.canvas.width/2+.5,i.canvas.height/2+.5),i.context.beginPath(),t.forEach(function(t,e){0===e?i.context.moveTo(t[0],t[1]):i.context.lineTo(t[0],t[1])}),i.context.closePath(),i.context.fillStyle="rgba(3,23,60,0.8)",i.context.strokeStyle="#2268A0",i.props.mapConfig&&i.props.mapConfig.map&&i.props.mapConfig.map.areaBackgroundColor&&(i.context.fillStyle=i.props.mapConfig.map.areaBackgroundColor),i.props.mapConfig&&i.props.mapConfig.map&&i.props.mapConfig.map.areaLineColor&&(i.context.strokeStyle=i.props.mapConfig.map.areaLineColor),i.context.stroke(),i.context.fill()}},i.renderCircle=function(){if(i.props.mapConfig&&i.props.mapConfig.toPoints&&i.props.mapConfig.fromPoint&&Array.isArray(i.props.mapConfig.fromPoint)&&Array.isArray(i.props.mapConfig.toPoints)){var t=!1,e=!0;i.props.mapConfig&&i.props.mapConfig.travelDirection&&"to-from"===i.props.mapConfig.travelDirection&&(e=!1),i.props.mapConfig&&i.props.mapConfig.travelDirection&&"none"===i.props.mapConfig.travelDirection&&(e=null),i.props.mapConfig&&i.props.mapConfig.travelType&&"circle"===i.props.mapConfig.travelType&&(t=!0);var a=[(i.lonlatTomercator(i.props.mapConfig.fromPoint)[0]-i.currentSource[0])*i.ratio,(i.currentSource[1]-i.lonlatTomercator(i.props.mapConfig.fromPoint)[1])*i.ratio];i.props.mapConfig.toPoints.forEach(function(n){var o=i.lonlatTomercator(n),r=[(o[0]-i.currentSource[0])*i.ratio,(i.currentSource[1]-o[1])*i.ratio],s=i.color[Math.floor(13*Math.random())];if(new i.CirclePoint(r[0],r[1],8,s,i.context,i.offCanvas,i.props.mapConfig.map.type).start(),i.circles.push(r),null!==e){var c=new i.LineStroke(e?a:r,e?r:a,i.context,s,.5,i.offCanvas,i.CirclePoint,t,i.props.mapConfig.map.type);c.start(),i.lines.push(c)}}),i.circle=new i.CirclePoint(a[0],a[1],8,i.color[Math.floor(13*Math.random())],i.context,i.offCanvas,i.props.mapConfig.map.type),i.circle.start()}},i.lonlatTomercator=function(t){var e=t,i=[],a=20037508.34*e[0]/180;Math.abs(e[1])>85.05112877980659&&(e[1]=85.05112877980659*Math.abs(e[1])/e[1]);var n=Math.log(Math.tan((90+e[1])*Math.PI/360))/(Math.PI/180);return n=20037508.34*n/180,i[0]=a,i[1]=n,i},i.distancePoint=function(t,e){var i=t[0]-e[0],a=t[1]-e[1];return Math.sqrt(i*i+a*a)},i.id=Math.random()+"-canvas",i.canvas=null,i.context=null,i.offCanvas=document.createElement("canvas"),i.offContext=i.offCanvas.getContext("2d"),i.maxScreenDis=0,i.sourceTomer=i.lonlatTomercator([-180,85.05112877980659]),i.maxGeoDis=i.distancePoint(i.sourceTomer,i.lonlatTomercator([180,-85.05112877980659])),i.ratio=0,i.areaArray=[],i.chinaPoints=[],i.screenPoints=[],i.Rect=null,i.lastArea=null,i.lastLine=null,i.scaleRatio=window.devicePixelRatio&&2===window.devicePixelRatio?2:1.2,i.minLng=0,i.maxLat=0,i.maxLength=0,i.circles=[],i.circle=null,i.lines=[],i.maxLng=null,i.minLng=null,i.maxLat=null,i.minLat=null,i.centerPoint=null,i.color=["#FDB933","#D64F44","#00A6AC","#1D953F","#E0861A","#45B97C","#F3715C","#F26522","#7FB80E","#63C5FA","#DDF8FF","#FFF3DD","#D45156"],i.CirclePoint=function(t,e,i,a,n,o,r){this.x=t,this.y=e,this.radius=i,this.color=a,this.context=n,this.offCanvas=o,this.tempRadius=this.radius,this.mapType=r,this.centerCirclePath=document.createElementNS("http://www.w3.org/2000/svg","circle"),this.centerCirclePath.setAttribute("cx",this.x),this.centerCirclePath.setAttribute("cy",this.y),this.centerCirclePath.setAttribute("r",this.radius),this.centerCirclePath.setAttribute("fill",this.color)},i.CirclePoint.prototype.createAreaPath=function(){this.context.beginPath(),this.context.rect(this.x-2*this.radius-this.context.lineWidth,this.y-2*this.radius-this.context.lineWidth,4*this.radius+this.context.lineWidth,4*this.radius+this.context.lineWidth)},i.CirclePoint.prototype.createCenterCirclePath=function(){this.context.beginPath(),this.context.arc(this.x,this.y,this.radius,0,2*Math.PI)},i.CirclePoint.prototype.createCenterCircleClipPath=function(){this.context.beginPath(),this.context.arc(this.x,this.y,this.radius+2,0,2*Math.PI)},i.CirclePoint.prototype.strokePath=function(){this.context.save(),this.context.strokeStyle=this.color,this.context.stroke(),this.context.restore()},i.CirclePoint.prototype.strokeCirclePath=function(){this.context.save(),this.context.strokeStyle=this.color,this.context.stroke(),this.context.restore(),this.context.restore()},i.CirclePoint.prototype.fillPath=function(){this.context.save(),this.context.fillStyle=this.color,this.context.fill(),this.context.restore()},i.CirclePoint.prototype.createFlashCirclePath=function(t){this.context.beginPath(),this.context.save(),this.context.globalAlpha=(3*this.radius-t)/(2*this.radius),this.context.arc(this.x,this.y,t,0,2*Math.PI)},i.CirclePoint.prototype.drawAnimate=function(){this.context.beginPath(),this.context.save(),this.context.arc(this.x,this.y,2.6*this.radius,0,2*Math.PI),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.context.arc(this.x,this.y,2.6*this.radius+2,0,2*Math.PI),this.context.clip(),"world"===this.mapType?this.context.drawImage(this.offCanvas,0,0):this.context.drawImage(this.offCanvas,-this.offCanvas.width/2,-this.offCanvas.height/2),this.context.restore(),this.createCenterCirclePath(),this.fillPath(),this.createFlashCirclePath(this.tempRadius+this.radius/3),this.strokeCirclePath(),this.createFlashCirclePath(this.tempRadius+2*this.radius/3),this.strokeCirclePath(),this.createFlashCirclePath(this.tempRadius),this.strokeCirclePath()},i.CirclePoint.prototype.animate=function(){this.tempRadius>=2*this.radius?this.tempRadius=this.radius:(this.tempRadius+=.2,this.drawAnimate()),window.requestAnimationFrame(this.animate.bind(this))},i.CirclePoint.prototype.start=function(){window.requestAnimationFrame(this.animate.bind(this))},i.LineStroke=function(t,e,i,a,n,o,r,s,c){this.from=t,this.to=e,this.context=i,this.color=a,this.width=n,this.offCanvas=o,this.mapType=c,this.path=window.document.createElementNS("http://www.w3.org/2000/svg","path"),this.pathLength=0,this.interLength=0,this.step=0,this.CirclePoint=r,this.circle=new this.CirclePoint(this.from[0],this.from[1],s?8:4,s?this.color:"rgba(255,255,255,0.8)",i,o),this.secondcircle=null},i.LineStroke.prototype.getControlPoint=function(){var t=this.to[1]>this.from[1]?this.to:this.from,e=this.to[1]>this.from[1]?this.from:this.to,i=t[1]-e[1],a=t[0]-e[0],n=(t[0]+e[0])/2,o=(t[1]+e[1])/2,r=Math.sqrt(i*i+a*a),s=Math.atan2(i,a);return[n-Math.sin(s)*r/5,o-Math.cos(s)*r/5]},i.LineStroke.prototype.createCurvePath=function(){this.context.beginPath(),this.context.moveTo(this.from[0],this.from[1]);var t=this.getControlPoint();this.context.quadraticCurveTo(t[0],t[1],this.to[0],this.to[1])},i.LineStroke.prototype.strokeCurve=function(){this.context.save(),this.context.strokeStyle=this.color,t.mapConfig&&"circle"===t.mapConfig.travelType&&(this.context.strokeStyle="transparent"),this.context.lineWidth=this.width,this.context.stroke(),this.context.restore()},i.LineStroke.prototype.createPath=function(){var t=this.getControlPoint();this.path.setAttributeNS(null,"d","M"+this.from[0]+" "+this.from[1]+" Q"+t[0]+" "+t[1]+" "+this.to[0]+" "+this.to[1]),this.pathLength=this.path.getTotalLength(),this.interLength=this.pathLength/100},i.LineStroke.prototype.start=function(){this.createCurvePath(),this.strokeCurve(),this.createPath(),window.requestAnimationFrame(this.animate.bind(this))},i.LineStroke.prototype.animate=function(){this.step>=this.pathLength&&(this.step=0),this.step+=this.interLength;var e=parseInt(this.path.getPointAtLength(this.step).x,10),i=parseInt(this.path.getPointAtLength(this.step).y,10);t.mapConfig&&"circle"!==t.mapConfig.travelType&&(this.secondcircle||(this.secondcircle=new this.CirclePoint(this.circle.x,this.circle.y,3,"rgba(255,255,255,0.6)",this.context,this.offCanvas)),this.step!==this.interLength||this.thirdcircle||(this.thirdcircle=new this.CirclePoint(this.circle.x,this.circle.y,2,"rgba(255,255,255,0.4)",this.context,this.offCanvas)),this.step!==2*this.interLength||this.fourthcircle||(this.fourthcircle=new this.CirclePoint(this.circle.x,this.circle.y,1,"rgba(255,255,255,0.2)",this.context,this.offCanvas))),this.fourthcircle&&(this.context.save(),this.fourthcircle.createCenterCirclePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.fourthcircle.createCenterCircleClipPath(),this.context.clip(),"province"!==this.mapType&&"district"!==this.mapType?this.context.drawImage(this.offCanvas,0,0):this.context.drawImage(this.offCanvas,-this.offCanvas.width/2,-this.offCanvas.height/2),this.context.restore()),this.thirdcircle&&(this.context.save(),this.thirdcircle.createCenterCirclePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.thirdcircle.createCenterCircleClipPath(),this.context.clip(),"province"!==this.mapType&&"district"!==this.mapType?this.context.drawImage(this.offCanvas,0,0):this.context.drawImage(this.offCanvas,-this.offCanvas.width/2,-this.offCanvas.height/2),this.context.restore()),this.secondcircle&&(this.context.save(),this.secondcircle.createCenterCirclePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.secondcircle.createCenterCircleClipPath(),this.context.clip(),"province"!==this.mapType&&"district"!==this.mapType?this.context.drawImage(this.offCanvas,0,0):this.context.drawImage(this.offCanvas,-this.offCanvas.width/2,-this.offCanvas.height/2),this.context.restore()),this.context.save(),this.circle.createCenterCirclePath(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.circle.createCenterCircleClipPath(),this.context.clip(),"province"!==this.mapType&&"district"!==this.mapType?this.context.drawImage(this.offCanvas,0,0):this.context.drawImage(this.offCanvas,-this.offCanvas.width/2,-this.offCanvas.height/2),this.context.restore(),this.createCurvePath(),this.strokeCurve(),this.fourthcircle&&(this.fourthcircle.x=this.thirdcircle.x,this.fourthcircle.y=this.thirdcircle.y,this.fourthcircle.createCenterCirclePath(),this.fourthcircle.fillPath()),this.thirdcircle&&(this.thirdcircle.x=this.secondcircle.x,this.thirdcircle.y=this.secondcircle.y,this.thirdcircle.createCenterCirclePath(),this.thirdcircle.fillPath()),this.secondcircle&&(this.secondcircle.x=this.circle.x,this.secondcircle.y=this.circle.y,this.secondcircle.createCenterCirclePath(),this.secondcircle.fillPath()),this.circle.x=e,this.circle.y=i,this.circle.createCenterCirclePath(),this.circle.fillPath(),window.requestAnimationFrame(this.animate.bind(this))},i.Point=function(t,e){this.x=t,this.y=e},i.Area=function(t,e){this.points=t,this.context=e},i.Area.prototype.createMapPath=function(){var t=this;"length"in this.points&&(this.context.beginPath(),this.points.forEach(function(e,i){0===i?t.context.moveTo(e.x,e.y):t.context.lineTo(e.x,e.y)}),this.context.closePath())},i.Area.prototype.drawMap=function(){this.createMapPath(),this.context.save(),this.context.translate(.5,.5),this.context.fillStyle="rgba(3,23,60,0.8)",this.context.strokeStyle="#2268A0",t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.areaBackgroundColor&&(this.context.fillStyle=t.mapConfig.map.areaBackgroundColor),t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.areaLineColor&&(this.context.strokeStyle=t.mapConfig.map.areaLineColor),this.context.fill(),this.context.stroke(),this.context.restore()},i.Area.prototype.cleardrawMap=function(){this.createMapPath(),this.context.save(),this.context.clip(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.fillStyle="#020B22",t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.mapBackgroundColor&&(this.context.fillStyle=t.mapConfig.map.mapBackgroundColor),this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.restore(),this.context.save(),this.context.translate(.5,.5),this.context.fillStyle="rgba(3,23,60,0.8)",this.context.strokeStyle="#2268A0",t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.areaBackgroundColor&&(this.context.fillStyle=t.mapConfig.map.areaBackgroundColor),t.mapConfig&&t.mapConfig.map&&t.mapConfig.map.areaLineColor&&(this.context.strokeStyle=t.mapConfig.map.areaLineColor),this.context.fill(),this.context.stroke(),this.context.restore()},i.Area.prototype.drawPath=function(){this.context.fill(),this.context.stroke()},i}return _inherits(e,_react2.default.Component),_createClass(e,[{key:"componentDidMount",value:function(){var t=this;this.canvas=document.getElementById(this.id),this.context=this.canvas.getContext("2d");var e=window.getComputedStyle(this.canvas.parentNode),i=Math.floor(window.parseInt(e.width)),a=Math.floor(window.parseInt(e.height));this.canvas.style.width=i+"px",this.canvas.style.height=a+"px",this.canvas.width=i*this.scaleRatio,this.canvas.height=a*this.scaleRatio,this.offCanvas.width=i*this.scaleRatio,this.offCanvas.height=a*this.scaleRatio,this.maxScreenDis=Math.sqrt(this.canvas.width*this.canvas.width+this.canvas.height*this.canvas.height),this.props.mapConfig&&this.props.mapConfig.map&&"world"===this.props.mapConfig.map.type&&(this.currentSource=this.sourceTomer,this.ratio=this.maxScreenDis/this.maxGeoDis,this.fetchJson("https://ludejun.github.io/deepviz/map/WorldMap.json",function(e){t.context=t.canvas.getContext("2d"),JSON.parse(e).features.forEach(function(e){if("Polygon"===e.geometry.type){var i=[];e.geometry.coordinates[0].forEach(function(e){var a=t.lonlatTomercator(e),n=(a[0]-t.sourceTomer[0])*t.ratio,o=Math.abs(a[1]-t.sourceTomer[1])*t.ratio,r=new t.Point(n,o);i.push(r)});var a=new t.Area(i,t.context);t.areaArray.push(a)}else"MultiPolygon"===e.geometry.type&&e.geometry.coordinates.forEach(function(e){var i=[];e[0].forEach(function(e){var a=t.lonlatTomercator(e),n=(a[0]-t.sourceTomer[0])*t.ratio,o=-(a[1]-t.sourceTomer[1])*t.ratio,r=new t.Point(n,o);i.push(r)});var a=new t.Area(i,t.context);t.areaArray.push(a)})}),t.context.fillStyle=t.props.mapConfig.map.mapBackgroundColor||"#020B22",t.context.fillRect(0,0,t.canvas.width,t.canvas.height),t.context.translate(.5,.5),t.areaArray.forEach(function(t){t.drawMap()}),t.offContext.drawImage(t.canvas,0,0),t.renderCircle()})),this.props.mapConfig&&this.props.mapConfig.map&&"province"===this.props.mapConfig.map.type&&this.props.mapConfig.map.name&&this.fetchJson("https://ludejun.github.io/deepviz/map/"+this.props.mapConfig.map.name+".json",function(e){t.context=t.canvas.getContext("2d"),JSON.parse(e).features.forEach(function(e){if("Polygon"===e.geometry.type){var i=[];e.geometry.coordinates[0].forEach(function(e){var a=t.lonlatTomercator(e),n=a[0],o=a[1];null===t.maxLng?t.maxLng=n:t.maxLng=Math.max(t.maxLng,n),null===t.minLng?t.minLng=n:t.minLng=Math.min(t.minLng,n),null===t.maxLat?t.maxLat=o:t.maxLat=Math.max(t.maxLat,o),null===t.minLat?t.minLat=o:t.minLat=Math.min(t.minLat,o);var r=new t.Point(n,o);i.push(r)});var a=new t.Area(i,t.context);t.areaArray.push(a)}else"MultiPolygon"===e.geometry.type&&e.geometry.coordinates.forEach(function(e){var i=[];e[0].forEach(function(e){var a=t.lonlatTomercator(e),n=a[0],o=a[1];null===t.maxLng?t.maxLng=n:t.maxLng=Math.max(t.maxLng,n),null===t.minLng?t.minLng=n:t.minLng=Math.min(t.minLng,n),null===t.maxLat?t.maxLat=o:t.maxLat=Math.max(t.maxLat,o),null===t.minLat?t.minLat=o:t.minLat=Math.min(t.minLat,o);var r=new t.Point(n,o);i.push(r)});var a=new t.Area(i,t.context);t.areaArray.push(a)})}),t.centerPoint=[(t.minLng+t.maxLng)/2,(t.maxLat+t.minLat)/2],t.currentSource=t.centerPoint,t.ratio=1.3*Math.min(t.canvas.width,t.canvas.height)/t.distancePoint([t.minLng,t.maxLat],[t.maxLng,t.minLat]);for(var i=t.areaArray.length-1;i>=0;i--)for(var a=t.areaArray[i].points,n=a.length-1;n>=0;n--){var o=a[n],r=(o.x-t.centerPoint[0])*t.ratio,s=-(o.y-t.centerPoint[1])*t.ratio;o.x=r,o.y=s}t.context.fillStyle=t.props.mapConfig.map.mapBackgroundColor||"#020B22",t.context.fillRect(0,0,t.canvas.width,t.canvas.height),t.context.translate(t.canvas.width/2+.5,t.canvas.height/2+.5),t.areaArray.forEach(function(t){t.drawMap()}),t.offContext.drawImage(t.canvas,0,0),t.renderCircle()}),this.props.mapConfig&&this.props.mapConfig.map&&"district"===this.props.mapConfig.map.type&&(window.mapLoad=this.mapLoad.bind(this),"undefined"==typeof BMap?this.loadScript():this.mapLoad())}},{key:"fetchJson",value:function(t,e){var i=new XMLHttpRequest;i.open("GET",t,!0),i.send(),i.onreadystatechange=function(){4===i.readyState&&200===i.status&&e(i.responseText)}}},{key:"render",value:function(){return _react2.default.createElement("div",{style:{position:"relative",width:"100%",height:"100%"}},_react2.default.createElement("canvas",{id:this.id},"对不起，您的浏览器不支持canvas"))}}]),e}();exports.default=ScatterCurveMap,ScatterCurveMap.propTypes={mapConfig:_propTypes2.default.shape({map:_propTypes2.default.object.isRequired}).isRequired};